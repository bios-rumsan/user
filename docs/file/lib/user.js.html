<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">lib/user.js | rs-user</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="RS User module"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="rs-user"><meta property="twitter:description" content="RS User module"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/user.js~User.html">User</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-account">account</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Schema">Schema</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#utils">utils</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/utils/token.js~Token.html">Token</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-decrypt">decrypt</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-encrypt">encrypt</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-generateSalt">generateSalt</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-generateToken">generateToken</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-hash">hash</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-saltAndHash">saltAndHash</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-NameParser">NameParser</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">lib/user.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/** @const */
const _ = require(&apos;lodash&apos;);
/** @const */
const fs = require(&apos;fs&apos;);
/** @const */
const {coroutine} = require(&apos;bluebird&apos;);
/** @const */
const {Promise} = require(&apos;bluebird&apos;);
/** @const */
const handlebars = require(&apos;handlebars&apos;);
/** @const */
const models = require(&apos;./models&apos;);
/** @const */
const utils = require(&apos;./utils&apos;);
/** @const */
const {Secure, NameParser} = require(&apos;./utils&apos;);
/** @const */
const tokenExpiration = 24 * 7 * 1000 * 60 * 60;
/** @const */
const tokenExpireBalancer = 3 * 1000;

var TokenUtil, AuthModel, CommModel, 
    UserModel, Mongoose, Mailer;

const stringToObjectId = (id) =&gt; {
    return Mongoose.Types.ObjectId(id);
}

const addCommsWithoutUserIdCheck = (user_id, comms) =&gt; {
    if(!Array.isArray(comms))
        comms = [comms];
    
    let arrComm = _.cloneDeep(comms);
    let promises = []

    _.each(arrComm, (comm)=&gt;{
        comm.user_id = stringToObjectId(user_id);
        comm.token = Math.floor(100000 + Math.random() * 900000);
        comm.token_expiration = Date.now() + tokenExpiration - tokenExpireBalancer;

        promises.push(
            new Promise((resolve)=&gt;{
                CommModel.findOne({user_id: stringToObjectId(user_id), address:comm.address}, (err, result) =&gt; {
                    if(!err){
                        if(!result){
                            let record = new CommModel(comm);
                            record.save(function(err, d){
                                resolve(d);
                            });
                        } else {
                            resolve(null)
                        }
                    } else {
                        resolve(null);
                    }
                })
            }
        ))
    })
    
    return Promise.all(promises);
};


class User {
    /**
        * @mongoose {object} Send reference to mongoose from your application.
        * @mailer {object} Send reference to fully configured nodemailer reference.
        * @app_secret {string} Your application secret. Must be 12 characters
        * @options {object} These are the valid options
        * @return {number} result of the sum value.
    */
    constructor({mongoose, mailer, app_secret, options}) {
    if (!mongoose)
        throw &apos;Mongoose is undefined&apos;;
    if (!mailer)
        throw &apos;Mailer is undefined.&apos;;
    if(!app_secret)
        throw &apos;App Secret is undefined.&apos;;
    if(app_secret.length!=32)
        throw &apos;App Secret must be 32 characters.&apos;;

        //Private variables
        let m = models(mongoose);
        AuthModel = m.Auth;
        CommModel = m.Comm;
        UserModel = m.User;
        TokenUtil = new utils.Token({app_secret});
        Mongoose = mongoose;

        this.options = options || {};
        this.options.jwt_duration = this.options.jwt_duration || 1000 * 60 * 20;
        this.mailer = mailer;

        
    }

    validateToken (token) {
        return TokenUtil.validate(token);
    }

    /**
     * 
     * @param {string} to - receiver email address
     * @param {object} data - data to be replaced in the template
     * @param {string} template - html template
     * @return {Boolean} success
     */
    sendMessage(to, data, template) {
        if(Mailer.disabled){
            console.log(&apos;Mailer is disabled&apos;);
            return;
        }
        
        const mailOptions = Object.assign({},
            Mailer.options[template], {
                data,
                to
            }
        );

        return new Promise((resolve, reject) =&gt; {
            fs.readFile(mailOptions.html, {
                encoding: &apos;utf-8&apos;
            }, function(err, html) {
                if (err) reject(err);
                var template = handlebars.compile(html);
                var htmlToSend = template(data);
                mailOptions.html = htmlToSend;

                if (data.subject) {
                    mailOptions.subject = data.subject;
                }

                Mailer.transporter.sendMail(mailOptions);
                resolve(true);
            });
        });
    }

    addAuth({user_id, username, type}) {
        return new Promise((resolve, reject) =&gt; {
            AuthModel.findOne({username}, (err,res) =&gt; {
                if(err) reject(err);
                if(res) reject(&apos;Auth already exists&apos;);
                let record = new AuthModel({
                    user_id: stringToObjectId(user_id),
                    username, type
                })
                record.save((err,res) =&gt; {
                    if(err) reject(err);
                    resolve(res);
                });
            })
        })
    }

    addComms(user_id, comms){
        return new Promise((resolve, reject)=&gt;{
            UserModel.findOne({_id: user_id, is_active:true})
            .then(data=&gt;{
                if(data){
                    addCommsWithoutUserIdCheck(user_id, comms)
                    .then(comms=&gt;resolve(comms))
                    .catch(err =&gt; reject(err))
                } else {
                    reject(&apos;User does not exists&apos;)
                }
            })
            .catch(err =&gt; reject(err))
        })
    }

    authenticate({username,password},options={}) {
        /*
            Options:
                TokenvalidFor (Number): Duration JWT Token valid for.
            */
        if (!username || !password) {
            throw new Error(&apos;Username and password required&apos;);
        }

        let jwt_duration = this.options.jwt_duration;
        if(options.jwt_duration)
            jwt_duration = options.TokenvalidFor;

        return new Promise((resolve, reject)=&gt;{
            this.getByUsername(username, {returnPwd:true})
            .then((user)=&gt;
                Secure.hash(password, Buffer.from(user.password.salt, &apos;base64&apos;))
                .then((hashedPwd)=&gt;{
                    if (user.password.hash !== hashedPwd.hash.toString(&apos;base64&apos;)) 
                        reject(&apos;Invalid username or password&apos;);
                    user.password = undefined;
                    user.token = TokenUtil.generate({user_id: user.id}, jwt_duration);
                    resolve(user);
                })
            )
            .catch((err)=&gt;{
                reject(err);
            })
        })
    };

    authExists({username}) {
        return new Promise((resolve, reject) =&gt; {
            AuthModel.findOne({username}, (err,res) =&gt; {
                if(err) reject(err);
                if(res) resolve(true);
                else resolve(false);
            })
        })
    };

    create(payload, options={}) {
        var me = this;
        /*
        payload: User object. Must send either email or phone.
            extras (object): Store non-standard attributes with the user object.
        options:
            comms_verified (Boolean): Flag is_verified to true in comms record
        */
        if(typeof payload.name==&apos;string&apos;)
            payload.name = NameParser.parse(payload.name)
        
        payload.auth = payload.auth || {};
        if(!payload.auth.username)
            throw new Error(&apos;Must send auth information&apos;);

        payload.password = payload.password || (Math.floor(100000 + Math.random() * 900000)).toString();
    
        var comms = payload.comms || [];
        if(payload.email){
            comms.push({
                type: &apos;email&apos;,
                address: payload.email,
                is_verified: options.comms_verified || false
            })
        }
        if(payload.phone){
            comms.push({
                type: &apos;phone&apos;,
                address: payload.phone,
                is_verified: options.comms_verified || false
            })
        }

        return new Promise((resolve, reject) =&gt; {   
            me.authExists(payload.auth)
            .then((exists)=&gt;{if (exists) throw new Error(&apos;Username already exists&apos;)})
            .then(()=&gt;Secure.saltAndHash(payload.password))
            .then((pwdHash) =&gt; {
                const user_record = new UserModel({
                    name: payload.name,
                    password: {
                        hash: pwdHash.hash.toString(&apos;base64&apos;),
                        salt: pwdHash.salt.toString(&apos;base64&apos;)
                    },
                    extras: payload.extras
                })
                user_record.save()
                .then(user =&gt; me.addAuth(Object.assign({}, payload.auth, {user_id: user_record._id})))
                .then(auth =&gt; me.addComms(user_record._id, comms))
                .then(()=&gt; me.getById(user_record._id))
                .then(user =&gt; resolve(user))
                .catch(err=&gt; {
                    UserModel.findOneAndDelete({_id:user_record._id}).exec();
                    AuthModel.deleteMany({user_id:user_record._id}).exec();
                    CommModel.deleteMany({user_id:user_record._id}).exec();
                    reject(err)
                })
            })
            .catch(err=&gt;reject(err))
            
        });
    };

    createUsingEmail(payload, options={}) {
        /*
        Options:
            notify (Boolean): Send notifications through email.
        */
       if(!payload.email)
            throw new Error(&apos;Email is required&apos;);

        payload.auth = {username: payload.email, type:&apos;email&apos;}

        return new Promise((resolve, reject) =&gt; {
            this.create(payload,options)
            .then((user) =&gt; {
                if(options.notify){
                    const emailData = Object.assign({rawPassword: payload.password}, user);
                    this.sendMessage(payload.email, emailData, &apos;signup&apos;);
                }

                resolve(user);
            })
            .catch(err =&gt; reject(err))
        });
    };

    createUsingPhone(payload, options={}) {
        /*
            notify (Boolean): Send notifications through phone.
        */
       if(!payload.phone)
            throw new Error(&apos;Phone number is required&apos;);

        payload.auth = {username: payload.phone, type:&apos;phone&apos;}

        return new Promise((resolve, reject) =&gt; {
            this.create(payload,options)
            .then((user) =&gt; {
                if(options.notify){
                    //ToDo: code for sending phone confirmation
                }

                resolve(user);
            })
            .catch(err =&gt; reject(err))
        });
    }

    getById(user_id, options = {}) {
        /*
        Options:
            returnPwd (Boolean): Return password hash or not.
        */
        let showFields = {password: 0}
        if(options.returnPwd)
            showFields = {};
        options.returnPwd = options.returnPwd || false;
        return new Promise((resolve,reject)=&gt;{
            UserModel.findOne({_id: user_id, is_active:true}, showFields, (err, user)=&gt;{
                if(err) reject(err);
                if(user){
                    CommModel.find({user_id},(err, comms) =&gt; {
                        if(err) reject(err);
                        user.comms = comms
                        resolve(user);
                    })
                } else {
                    resolve(null);
                }
            })
        })
    }
    
    getByUsername(address, options) {
        /*
        Options:
            returnPwd (Boolean): Return password hash or not.
        */
        return new Promise((resolve, reject) =&gt; {
            CommModel.findOne({address}, (err, comm) =&gt; {
                if (err) reject(err);
                if(comm){
                    this.getById(comm.user_id, options)
                    .then(data =&gt; resolve(data))
                    .error((err) =&gt; reject(err));
                }
                else
                    reject(&apos;Username does not exists&apos;);
            });
        });
    };
    
    getMe(token) {
        return new Promise((resolve, reject) =&gt; {
            TokenUtil.validate(token)
            .then(token_data=&gt;this.getById(token_data.data.user_id))           
            .then(data =&gt; resolve(data))
            .catch(err =&gt; reject(err));
        });
    };     
}

module.exports = User</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
